<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini App Test</title>
    <script src="telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #000000);
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.8;
        }

        button:active {
            opacity: 0.6;
        }

        #logSection {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-wrap: break-word;
        }

        .log-entry.info {
            border-left: 3px solid #3390ec;
        }

        .log-entry.error {
            border-left: 3px solid #e74c3c;
            color: #e74c3c;
        }

        .log-entry.success {
            border-left: 3px solid #2ecc71;
        }

        .clear-btn {
            margin-top: 10px;
            background-color: var(--tg-theme-destructive-text-color, #e74c3c);
        }

        .music-player {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .player-info {
            margin-bottom: 15px;
            text-align: center;
        }

        .track-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--tg-theme-text-color, #000000);
        }

        .player-status {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
        }

        #playerStatus {
            font-weight: 600;
            text-transform: uppercase;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .player-controls button {
            flex: 1;
            max-width: 100px;
        }

        .player-timeline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .player-timeline span {
            font-size: 12px;
            font-family: monospace;
            min-width: 40px;
            color: var(--tg-theme-text-color, #000000);
        }

        .seek-bar,
        .volume-bar {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--tg-theme-hint-color, #dddddd);
            outline: none;
        }

        .seek-bar::-webkit-slider-thumb,
        .volume-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #3390ec);
            cursor: pointer;
        }

        .seek-bar::-moz-range-thumb,
        .volume-bar::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #3390ec);
            cursor: pointer;
            border: none;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .volume-control span {
            font-size: 12px;
            min-width: 45px;
            color: var(--tg-theme-text-color, #000000);
        }

        .player-debug {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .player-debug button {
            flex: 1;
            font-size: 12px;
            padding: 8px 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mini App Test Interface</h1>

        <div class="section">
            <h2>Basic Tests</h2>
            <div class="button-grid">
                <button onclick="testReady()">Ready</button>
                <button onclick="testExpand()">Expand</button>
                <button onclick="testClose()">Close</button>
                <button onclick="testHaptic()">Haptic Feedback</button>
            </div>
        </div>

        <div class="section">
            <h2>User Info</h2>
            <div class="button-grid">
                <button onclick="getUserData()">Get User Data</button>
                <button onclick="getInitData()">Get Init Data</button>
                <button onclick="getThemeParams()">Get Theme</button>
                <button onclick="getViewport()">Get Viewport</button>
            </div>
        </div>

        <div class="section">
            <h2>Interactions</h2>
            <div class="button-grid">
                <button onclick="showAlert()">Show Alert</button>
                <button onclick="showConfirm()">Show Confirm</button>
                <button onclick="showPopup()">Show Popup</button>
                <button onclick="openLink()">Open Link</button>
            </div>
        </div>

        <div class="section">
            <h2>Main Button</h2>
            <div class="button-grid">
                <button onclick="showMainButton()">Show Main Button</button>
                <button onclick="hideMainButton()">Hide Main Button</button>
                <button onclick="setMainButtonText()">Change Text</button>
            </div>
        </div>

        <div class="section">
            <h2>Music Player</h2>
            <div id="musicPlayerContainer" class="music-player">
                <audio id="audioElement" preload="metadata"></audio>

                <div class="player-info">
                    <div class="track-title">Ready to play</div>
                    <div class="player-status">Status: <span id="playerStatus">stopped</span></div>
                </div>

                <div class="player-controls">
                    <button id="playBtn" onclick="playAudio()">Play</button>
                    <button id="pauseBtn" onclick="pauseAudio()">Pause</button>
                    <button id="stopBtn" onclick="stopAudio()">Stop</button>
                </div>

                <div class="player-timeline">
                    <span id="currentTime">0:00</span>
                    <input
                        type="range"
                        id="seekBar"
                        min="0"
                        max="100"
                        value="0"
                        class="seek-bar"
                        oninput="seekAudio(this.value)"
                    />
                    <span id="duration">0:00</span>
                </div>

                <div class="volume-control">
                    <span>Volume:</span>
                    <input
                        type="range"
                        id="volumeBar"
                        min="0"
                        max="100"
                        value="100"
                        class="volume-bar"
                        oninput="changeVolume(this.value)"
                    />
                    <span id="volumeValue">100%</span>
                </div>

                <div class="player-debug">
                    <button onclick="loadTestTrack()">Load Test Track</button>
                    <button onclick="getPlayerState()">Get State</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Log Console</h2>
            <div id="logSection"></div>
            <button class="clear-btn" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        // Override console.log to also display in the log section
        const originalLog = console.log;
        const originalError = console.error;

        function addLog(message, type = 'info') {
            const logSection = document.getElementById('logSection');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            const messageStr = typeof message === 'object' ? JSON.stringify(message, null, 2) : String(message);

            entry.textContent = `[${timestamp}] ${messageStr}`;
            logSection.appendChild(entry);
            logSection.scrollTop = logSection.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');

            // Filter out unwanted logs
            const filterPatterns = ['tgbrowser', 'scroll'];
            const shouldFilter = filterPatterns.some(pattern => message.toLowerCase().includes(pattern));

            if (!shouldFilter) {
                addLog(message, 'info');
            }
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
            addLog(message, 'error');
        };

        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;

        function testReady() {
            console.log('Calling ready()...');
            tg.ready();
            addLog('WebApp ready() called', 'success');
        }

        function testExpand() {
            console.log('Expanding WebApp...');
            tg.expand();
            addLog('WebApp expanded', 'success');
        }

        function testClose() {
            console.log('Closing WebApp...');
            tg.close();
        }

        function testHaptic() {
            console.log('Triggering haptic feedback...');
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
                addLog('Haptic feedback triggered', 'success');
            } else {
                addLog('Haptic feedback not available', 'error');
            }
        }

        function getUserData() {
            console.log('User data:', tg.initDataUnsafe.user);
            addLog('User: ' + JSON.stringify(tg.initDataUnsafe.user || 'No user data'), 'info');
        }

        function getInitData() {
            console.log('Init data:', tg.initData);
            addLog('Init data: ' + (tg.initData || 'Empty'), 'info');
        }

        function getThemeParams() {
            console.log('Theme params:', tg.themeParams);
            addLog('Theme: ' + JSON.stringify(tg.themeParams), 'info');
        }

        function getViewport() {
            const viewport = {
                height: tg.viewportHeight,
                stableHeight: tg.viewportStableHeight,
                isExpanded: tg.isExpanded
            };
            console.log('Viewport:', viewport);
            addLog('Viewport: ' + JSON.stringify(viewport), 'info');
        }

        function showAlert() {
            console.log('Showing alert...');
            tg.showAlert('This is a test alert!', () => {
                addLog('Alert closed', 'success');
            });
        }

        function showConfirm() {
            console.log('Showing confirm...');
            tg.showConfirm('Do you want to continue?', (confirmed) => {
                addLog('Confirm result: ' + confirmed, 'success');
            });
        }

        function showPopup() {
            console.log('Showing popup...');
            tg.showPopup({
                title: 'Test Popup',
                message: 'This is a test popup message',
                buttons: [
                    {id: 'ok', type: 'ok'},
                    {id: 'cancel', type: 'cancel'}
                ]
            }, (buttonId) => {
                addLog('Popup button clicked: ' + buttonId, 'success');
            });
        }

        function openLink() {
            console.log('Opening link...');
            tg.openLink('https://telegram.org');
            addLog('Link opened', 'success');
        }

        function showMainButton() {
            console.log('Showing main button...');
            tg.MainButton.setText('Main Button');
            tg.MainButton.show();
            tg.MainButton.onClick(() => {
                addLog('Main button clicked!', 'success');
            });
            addLog('Main button shown', 'success');
        }

        function hideMainButton() {
            console.log('Hiding main button...');
            tg.MainButton.hide();
            addLog('Main button hidden', 'success');
        }

        function setMainButtonText() {
            console.log('Changing main button text...');
            tg.MainButton.setText('Custom Text ' + Date.now());
            addLog('Main button text changed', 'success');
        }

        function clearLogs() {
            document.getElementById('logSection').innerHTML = '';
            originalLog('Logs cleared');
        }

        // Music Player Functions
        let isPlayerInitialized = false;
        let isSeeking = false;

        function initMusicPlayer() {
            if (isPlayerInitialized) return;

            const audioElement = document.getElementById('audioElement');

            try {
                tg.AudioPlayer.init(audioElement);
                isPlayerInitialized = true;

                addLog('Music player initialized', 'success');

                audioElement.addEventListener('play', updatePlayerUI);
                audioElement.addEventListener('pause', updatePlayerUI);
                audioElement.addEventListener('ended', updatePlayerUI);
                audioElement.addEventListener('loadedmetadata', function() {
                    document.getElementById('duration').textContent = formatTime(audioElement.duration);
                    document.getElementById('seekBar').max = audioElement.duration;
                });
                audioElement.addEventListener('timeupdate', function() {
                    if (!isSeeking) {
                        document.getElementById('currentTime').textContent = formatTime(audioElement.currentTime);
                        document.getElementById('seekBar').value = audioElement.currentTime;
                    }
                });

            } catch (error) {
                addLog('Failed to initialize music player: ' + error.message, 'error');
            }
        }

        function updatePlayerUI() {
            const state = tg.AudioPlayer.state;
            document.getElementById('playerStatus').textContent = state;

            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');

            if (state === 'playing') {
                playBtn.disabled = true;
                pauseBtn.disabled = false;
            } else if (state === 'paused' || state === 'stopped') {
                playBtn.disabled = false;
                pauseBtn.disabled = true;
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        function loadTestTrack() {
            initMusicPlayer();

            const url = 'https://dl6.songsara.net/FRE/15/For%20A%20Hero%20(Playlist)/02%20Another%20Dawn.mp3';
            const title = 'Sample music';
            const description = 'this is a description';

            try {
                tg.AudioPlayer.load(url);
                document.querySelector('.track-title').textContent = title;
                addLog('Track loaded: ' + url, 'success');
            } catch (error) {
                addLog('Failed to load track: ' + error.message, 'error');
            }
        }

        function playAudio() {
            initMusicPlayer();

            try {
                tg.AudioPlayer.play();
                addLog('Playing audio', 'success');
            } catch (error) {
                addLog('Play failed: ' + error.message, 'error');
            }
        }

        function pauseAudio() {
            if (!isPlayerInitialized) return;

            try {
                tg.AudioPlayer.pause();
                addLog('Audio paused', 'success');
            } catch (error) {
                addLog('Pause failed: ' + error.message, 'error');
            }
        }

        function stopAudio() {
            if (!isPlayerInitialized) return;

            try {
                tg.AudioPlayer.stop();
                addLog('Audio stopped', 'success');
            } catch (error) {
                addLog('Stop failed: ' + error.message, 'error');
            }
        }

        function seekAudio(value) {
            if (!isPlayerInitialized) return;

            isSeeking = true;
            try {
                tg.AudioPlayer.seek(parseFloat(value));
                document.getElementById('currentTime').textContent = formatTime(value);
            } catch (error) {
                addLog('Seek failed: ' + error.message, 'error');
            }

            setTimeout(() => { isSeeking = false; }, 100);
        }

        function changeVolume(value) {
            if (!isPlayerInitialized) return;

            const volume = parseInt(value) / 100;
            try {
                tg.AudioPlayer.setVolume(volume);
                document.getElementById('volumeValue').textContent = value + '%';
                addLog('Volume: ' + value + '%', 'info');
            } catch (error) {
                addLog('Volume change failed: ' + error.message, 'error');
            }
        }

        function getPlayerState() {
            if (!isPlayerInitialized) {
                addLog('Player not initialized', 'error');
                return;
            }

            const state = tg.AudioPlayer.getState();
            addLog('Player state: ' + JSON.stringify(state, null, 2), 'info');
        }

        // Initialize
        console.log('Mini App Test Interface loaded');
        console.log('Telegram WebApp version:', tg.version);
        console.log('Platform:', tg.platform);
    </script>
</body>
</html>
